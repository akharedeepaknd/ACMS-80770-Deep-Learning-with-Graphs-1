
source("spectral.R")
source("Simulation_Testing.R")
source("datagen.R")

########################################
#                 TODO                 #
# 1. Simulate overlapping communities  #
# 2. Visualize overlapping communities #
########################################

# Simulate simple SBModels
# Two clusters
B <- matrix(c(1.0,0.3,0.3,1.0), 2, 2)
Z <- t(rmultinom(100, size = 1, prob = c(0.2,0.8)))

A <- Z %*% B %*% t(Z)
cls <- apply(Z, 1, which.max)
A <- apply(A, c(1, 2), function(x) rbinom(1,1,x))

# Three clusters
B <- matrix(c(0.9,0.2,0.2,0.4,0.9,0.4,0.2,0.2,0.9), 3, 3)
Z <- t(rmultinom(100, size = 1, prob = c(0.1,0.2,0.8)))

A <- Z %*% B %*% t(Z)
cls <- apply(Z, 1, which.max)
A <- apply(A, c(1, 2), function(x) rbinom(1,1,x))


ret <- OCCAM(A, 3)
ret2 <- SAAC(A, 3, m = 1)
# Difficult Data

library(mlbench)

obj <- mlbench.spirals(100,1,0.025)
X <-  4 * obj$x
plot(X, col=obj$classes)
n <- nrow(X)
cls <- obj$classes
# (x-y)^2 = x^2 + y^2 -2xy

W_orig <- sqrt(matrix(rep(X[,1]^2, 2), n, n) + t(matrix(rep(X[,1]^2, 2), n, n)) -2*(X[,1] %*% t(X[,1])) + matrix(rep(X[,2]^2, 2), n, n) + t(matrix(rep(X[,2]^2, 2), n, n)) -2*(X[,2] %*% t(X[,2])) )
W <- W_orig
W[W_orig<0.9] <- -1
W[W_orig>0.9] <- 0
W[W==-1] <- 1


ret <- OCCAM(W, 2)
library("qgraph")
par(mfrow = c(1, 3))
plot(X, col=obj$classes)
title("Actual")
qgraph(W, layout="spring", title="test",
       groups = list("Black" = which(obj$classes==1), "Red" = which(obj$classes==2)), color = c("lightblue", "lightsalmon"))
plot(X, col=ret$cluster)
title("Estimated by OCCAM")


ret <- SAAC(W, 2, m =1)
library("qgraph")
par(mfrow = c(1, 3))
plot(X, col=obj$classes)
title("Actual")
qgraph(W, layout="spring", title="test",
       groups = list("Black" = which(obj$classes==1), "Red" = which(obj$classes==2)), color = c("lightblue", "lightsalmon"))
plot(X, col=ret$cluster)
title("Estimated by SAAC")




###--------- Simulate Z and Z_hat ---------------
n <- 100
K <- 3

Z <- matrix(rep(NA, n*K), n, K)
for (i in seq(n)){
  Z[i,sample(seq(K),1)] <- 1
}
Z[is.na(Z)] <- sample(c(0,1),sum(is.na(Z)), replace = T)

Z_hat <- matrix(rep(NA, n*K), n, K)
for (i in seq(n)){
  Z_hat[i,sample(seq(K),1)] <- 1
}
Z_hat[is.na(Z_hat)] <- sample(c(0,1),sum(is.na(Z_hat)), replace = T)

Z_test <- Z[,ncol(Z):1]


Estim_error(Z, Z)
Estim_error(Z_hat, Z)
Estim_error(Z_test, Z) # robust with label switching

NVI(Z, Z)
NVI(Z_hat, Z)
NVI(Z_test,Z) # robust with label switching

###--------- Perturbing Edges -------------

A <- matrix(rep(0,n*n), n, n)
list <- sample(c(0,1),choose(n,2), replace = T)
A[lower.tri(A)] <- list
A <- t(A)
A[lower.tri(A)] <- list

perturb_A <- rewireR(A,nperturb = choose(n,2)*.1, dist = 'NegBinom') # distribution undetermined


### Test datagen

library(ggplot2)
library(dplyr)


trudata <- gen_SBM_testdata(1000)
ret = OCCAM(trudata$A, 3)
Estim_error(ret$Zones, trudata$Z)
NVI(ret$Zones, trudata$Z)

ret2 = SAAC(trudata$A, 3, m=3)
Estim_error(ret2$Zones, trudata$Z)
NVI(ret2$Zones, trudata$Z)


trudata <- gen_LSM_testdata(1000)
ret = OCCAM(trudata$A, 2)
Estim_error(ret$Zones, trudata$Z)
NVI(ret$Zones, trudata$Z)

ret2 = SAAC(trudata$A, 2, m=2)
Estim_error(ret2$Zones, trudata$Z)
NVI(ret2$Zones, trudata$Z)

df_SBM <- data.frame(n=c(), Estim_error=c(), NVI=c(), Method=c())
df_LSM <- data.frame(n=c(), Estim_error=c(), NVI=c(), Method=c())

ns=c(100, 250, 500, 750, 1000)
conds <- length(ns)
for (i in 1:conds) {
  for (r in 1:50) {
    trudata <- gen_SBM_testdata(ns[i])
    ret = OCCAM(trudata$A, 3)
    df_SBM = rbind(df_SBM, list(
      n = ns[i],
      Estim_error = Estim_error(ret$Zones, trudata$Z),
      NVI = NVI(ret$Zones, trudata$Z),
      Method = "OCCAM"
    ))
    
    ret2 = SAAC(trudata$A, 3, m=3)
    df_SBM = rbind(df_SBM, list(
      n = ns[i],
      Estim_error = Estim_error(ret2$Zones, trudata$Z),
      NVI = NVI(ret2$Zones, trudata$Z),
      Method = "SAAC"
    ))
  }
}

df_SBM_sum = df_SBM %>% group_by(n, Method) %>% summarise_all(mean)

ggplot(df_SBM_sum, aes(n, Estim_error, col=Method)) + ggtitle("Error (Data generated by SBMO)") + geom_line()
ggplot(df_SBM_sum, aes(n, NVI, col=Method)) + ggtitle("NVI (Data generated by SBMO)") + geom_line()


for (i in 1:conds) {
  for (r in 1:50) {
    trudata <- gen_LSM_testdata(ns[i])
    ret = OCCAM(trudata$A, 2)
    df_LSM = rbind(df_LSM, list(
      n = ns[i],
      Estim_error = Estim_error(ret$Zones, trudata$Z),
      NVI = NVI(ret$Zones, trudata$Z),
      Method = "OCCAM"
    ))
    
    ret2 = SAAC(trudata$A, 2, m=2)
    df_LSM = rbind(df_LSM, list(
      n = ns[i],
      Estim_error = Estim_error(ret2$Zones, trudata$Z),
      NVI = NVI(ret2$Zones, trudata$Z),
      Method = "SAAC"
    ))
  }
}


df_LSM_sum = df_LSM %>% group_by(n, Method) %>% summarise_all(mean)
ggplot(df_LSM_sum, aes(n, Estim_error, col=Method)) + ggtitle("Error (Data generated by LSM)") + geom_line()
ggplot(df_LSM_sum, aes(n, NVI, col=Method))  + ggtitle("NVI (Data generated by LSM)") + geom_line()

